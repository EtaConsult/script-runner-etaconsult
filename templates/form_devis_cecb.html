<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nouveau Devis CECB - Script Runner</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://maps.googleapis.com/maps/api/js?key={{ google_api_key }}&libraries=places&language=fr&region=CH"></script>
    <style>
        .form-container {
            display: grid;
            grid-template-columns: 280px 1fr 400px;
            gap: 2rem;
            margin-top: 2rem;
        }

        @media (max-width: 1400px) {
            .form-container {
                grid-template-columns: 1fr 400px;
            }
            .tarifs-panel { display: none; }
        }

        @media (max-width: 1200px) {
            .form-container {
                grid-template-columns: 1fr;
            }
        }

        /* Panneau tarifs */
        .tarifs-panel {
            background: var(--surface);
            border-radius: 12px;
            padding: 1.25rem;
            box-shadow: 0 1px 3px var(--shadow);
            position: sticky;
            top: 1rem;
            max-height: calc(100vh - 2rem);
            overflow-y: auto;
        }

        .tarifs-panel h3 {
            font-size: 1rem;
            margin-bottom: 1rem;
            color: var(--primary);
        }

        .tarif-group {
            margin-bottom: 0.75rem;
        }

        .tarif-group label {
            display: block;
            font-size: 0.75rem;
            color: var(--text-light);
            margin-bottom: 0.2rem;
        }

        .tarif-group input {
            width: 100%;
            padding: 0.4rem 0.6rem;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 0.85rem;
            font-family: inherit;
        }

        .tarif-group input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .tarif-separator {
            border-top: 1px solid var(--border);
            margin: 0.75rem 0;
            font-size: 0.7rem;
            color: var(--text-light);
            text-transform: uppercase;
            padding-top: 0.5rem;
            font-weight: 600;
        }

        .tarif-info {
            font-size: 0.7rem;
            color: var(--text-light);
            font-style: italic;
            margin-top: 0.5rem;
        }

        .form-panel {
            background: var(--surface);
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 1px 3px var(--shadow);
        }

        .form-panel h2 {
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            color: var(--text);
        }

        .section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: var(--bg);
            border-radius: 8px;
            border-left: 4px solid var(--primary);
        }

        .section-title {
            font-size: 1.1rem;
            color: var(--primary);
            margin-bottom: 1.25rem;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text);
            font-weight: 500;
            font-size: 0.9rem;
        }

        .form-group label .required {
            color: var(--error);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.65rem 0.85rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.95rem;
            font-family: inherit;
            transition: border-color 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        @media (max-width: 768px) {
            .row {
                grid-template-columns: 1fr;
            }
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
            padding: 0.85rem;
            background: white;
            border-radius: 6px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .checkbox-group label {
            margin: 0 !important;
            cursor: pointer;
            font-weight: 500;
            color: var(--primary);
        }

        .hidden {
            display: none;
        }

        .button-group {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }

        .btn {
            flex: 1;
            padding: 0.85rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .btn-primary:disabled {
            background: var(--text-light);
            cursor: not-allowed;
        }

        .btn-secondary {
            background: var(--border);
            color: var(--text);
        }

        .btn-secondary:hover {
            background: #cbd5e1;
        }

        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 1rem;
            margin-bottom: 1.5rem;
            border-radius: 4px;
            font-size: 0.9rem;
            color: #1976d2;
        }

        /* Autocomplete styling */
        .pac-container {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            margin-top: 4px;
        }

        .pac-item {
            padding: 8px 12px;
            cursor: pointer;
            border-top: 1px solid var(--border);
        }

        .pac-item:first-child {
            border-top: none;
        }

        .pac-item:hover {
            background: var(--bg);
        }

        .pac-icon {
            display: none;
        }

        .pac-item-query {
            font-size: 0.95rem;
            color: var(--text);
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
            margin-bottom: 1.5rem;
        }

        .back-link:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="/" class="back-link">‚Üê Retour au tableau de bord</a>
        <header>
            <h1>üè† Cr√©er un Devis CECB</h1>
            <p class="subtitle">G√©n√©rer automatiquement un devis CECB, CECB Plus ou Conseil Incitatif dans Bexio</p>
        </header>

        <div class="form-container">
            <!-- Panneau tarifs (gauche) -->
            <div class="tarifs-panel" id="tarifsPanel">
                <h3>Tarifs</h3>
                <div id="tarifsFields">
                    <p class="tarif-info">Chargement...</p>
                </div>
                <p class="tarif-info">Les modifications s'appliquent uniquement √† ce devis.</p>
            </div>

            <!-- Panneau du formulaire -->
            <div class="form-panel">
                <div class="info-box">
                    üí° <strong>Astuce :</strong> Les champs d'adresse utilisent l'autocompl√©tion Google. Commencez √† taper et s√©lectionnez l'adresse sugg√©r√©e.
                </div>

                <form id="devisForm">
                    <!-- SECTION 1: COORDONN√âES CLIENT -->
                    <div class="section">
                        <div class="section-title">üë§ Coordonn√©es du client</div>

                        <div class="form-group">
                            <label for="type_contact">Type de contact <span class="required">*</span></label>
                            <select id="type_contact" name="type_contact" required>
                                <option value="Priv√©">Priv√©</option>
                                <option value="Soci√©t√©">Soci√©t√©</option>
                            </select>
                        </div>

                        <div class="form-group hidden" id="group_nom_entreprise">
                            <label for="nom_entreprise">Nom de l'entreprise <span class="required">*</span></label>
                            <input type="text" id="nom_entreprise" name="nom_entreprise">
                        </div>

                        <div class="form-group">
                            <label for="appellation">Appellation <span class="required">*</span></label>
                            <select id="appellation" name="appellation" required>
                                <option value="Mme">Madame</option>
                                <option value="M.">Monsieur</option>
                                <option value="Mx">Neutre</option>
                            </select>
                        </div>

                        <div class="row">
                            <div class="form-group">
                                <label for="nom_famille">Nom de famille <span class="required">*</span></label>
                                <input type="text" id="nom_famille" name="nom_famille" required>
                            </div>

                            <div class="form-group">
                                <label for="prenom">Pr√©nom <span class="required">*</span></label>
                                <input type="text" id="prenom" name="prenom" required>
                            </div>
                        </div>

                        <div class="row">
                            <div class="form-group">
                                <label for="email">Email <span class="required">*</span></label>
                                <input type="email" id="email" name="email" required>
                            </div>

                            <div class="form-group">
                                <label for="telephone">T√©l√©phone</label>
                                <input type="tel" id="telephone" name="telephone" placeholder="+41 79 123 45 67">
                            </div>
                        </div>
                    </div>

                    <!-- SECTION 2: ADRESSE DE FACTURATION -->
                    <div class="section">
                        <div class="section-title">üìç Adresse de facturation</div>

                        <div class="form-group">
                            <label for="rue_facturation">Adresse compl√®te <span class="required">*</span></label>
                            <input type="text" id="rue_facturation" name="rue_facturation" placeholder="Commencez √† taper l'adresse..." required>
                        </div>

                        <div class="row">
                            <div class="form-group">
                                <label for="npa_facturation">NPA <span class="required">*</span></label>
                                <input type="text" id="npa_facturation" name="npa_facturation" required>
                            </div>

                            <div class="form-group">
                                <label for="localite_facturation">Localit√© <span class="required">*</span></label>
                                <input type="text" id="localite_facturation" name="localite_facturation" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="pays_facturation">Pays</label>
                            <input type="text" id="pays_facturation" name="pays_facturation" value="Suisse">
                        </div>
                    </div>

                    <!-- SECTION 3: ADRESSE DU B√ÇTIMENT -->
                    <div class="section">
                        <div class="section-title">üè¢ Adresse du b√¢timent</div>

                        <div class="checkbox-group">
                            <input type="checkbox" id="adresse_identique" name="adresse_identique">
                            <label for="adresse_identique">Identique √† l'adresse de facturation</label>
                        </div>

                        <div id="adresse_batiment_fields">
                            <div class="form-group">
                                <label for="rue_batiment">Adresse compl√®te du b√¢timent <span class="required">*</span></label>
                                <input type="text" id="rue_batiment" name="rue_batiment" placeholder="Commencez √† taper l'adresse..." required>
                            </div>

                            <div class="row">
                                <div class="form-group">
                                    <label for="npa_batiment">NPA <span class="required">*</span></label>
                                    <input type="text" id="npa_batiment" name="npa_batiment" required>
                                </div>

                                <div class="form-group">
                                    <label for="localite_batiment">Localit√© <span class="required">*</span></label>
                                    <input type="text" id="localite_batiment" name="localite_batiment" required>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- SECTION 4: CARACT√âRISTIQUES DU B√ÇTIMENT -->
                    <div class="section">
                        <div class="section-title">üîß Caract√©ristiques du b√¢timent</div>

                        <div class="form-group">
                            <label for="type_certificat">Type de certificat <span class="required">*</span></label>
                            <select id="type_certificat" name="type_certificat" required>
                                <option value="CECB">CECB</option>
                                <option value="CECB Plus">CECB Plus</option>
                                <option value="Conseil Incitatif">Conseil Incitatif</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="nombre_etages">Nombre d'√©tages hors-sol <span class="required">*</span></label>
                            <input type="number" id="nombre_etages" name="nombre_etages" min="1" max="20" value="2" required>
                            <small style="color: #64748b; font-size: 0.85rem; display: block; margin-top: 0.25rem;">
                                Valeur du RegBL. Modifiable si incorrecte.
                            </small>
                        </div>

                        <div class="row">
                            <div class="form-group">
                                <label for="sous_sol">Niveaux en sous-sol</label>
                                <select id="sous_sol" name="sous_sol">
                                    <option value="Non chauff√© ou inexistant">Non chauff√© ou inexistant</option>
                                    <option value="Partiellement chauff√© 50%">Partiellement chauff√© 50%</option>
                                    <option value="Chauff√© 30%">Chauff√© 30%</option>
                                    <option value="Chauff√©">Chauff√©</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="combles">Combles</label>
                                <select id="combles" name="combles">
                                    <option value="Non chauff√© ou inexistant">Non chauff√© ou inexistant</option>
                                    <option value="Partiellement chauff√© 50%">Partiellement chauff√© 50%</option>
                                    <option value="Chauff√© 30%">Chauff√© 30%</option>
                                    <option value="Chauff√©">Chauff√©</option>
                                </select>
                            </div>
                        </div>

                        <!-- CECB existant (mise √† jour) -->
                        <div class="checkbox-group" id="group_cecb_existant">
                            <input type="checkbox" id="cecb_existant" name="cecb_existant">
                            <label for="cecb_existant">CECB existant (mise √† jour)</label>
                        </div>

                        <div class="form-group hidden" id="group_rabais_cecb">
                            <label for="rabais_cecb">Rabais sur le prix du CECB (CHF)</label>
                            <input type="number" id="rabais_cecb" name="rabais_cecb" min="0" step="10" value="0">
                            <small style="color: #64748b; font-size: 0.85rem; display: block; margin-top: 0.25rem;">
                                + Position "Transfert du CECB" √† <span id="frais_transfert_label">90</span> CHF HT ajout√©e automatiquement.
                            </small>
                        </div>

                        <div class="form-group" id="group_delai">
                            <label for="delai">D√©lai</label>
                            <select id="delai" name="delai">
                                <option value="Normal">Normal</option>
                                <option value="Express" id="option_express">Express (+155 CHF)</option>
                                <option value="Urgent" id="option_urgent">Urgent (+310 CHF)</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="contexte">Contexte</label>
                            <select id="contexte" name="contexte">
                                <option value="Vente">Vente</option>
                                <option value="Remplacement de chaudi√®re fossile">Remplacement de chaudi√®re fossile</option>
                                <option value="R√©flexion/entretien du bien">R√©flexion/entretien du bien</option>
                                <option value="Travaux de r√©novation">Travaux de r√©novation</option>
                                <option value="Projet de loi sur l'Energie (VD)">Projet de loi sur l'Energie (VD)</option>
                                <option value="Autre">Autre</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="message">Message (optionnel)</label>
                            <textarea id="message" name="message" placeholder="Informations compl√©mentaires..."></textarea>
                        </div>
                    </div>

                    <!-- BOUTONS -->
                    <div class="button-group">
                        <button type="button" class="btn btn-secondary" onclick="window.location.href='/'">Annuler</button>
                        <button type="submit" class="btn btn-primary" id="submitBtn">Cr√©er le devis</button>
                    </div>
                </form>
            </div>

            <!-- Panneau des logs -->
            <div class="logs-panel">
                <h2>üìã Logs d'ex√©cution</h2>
                <div id="logs" class="logs-container">
                    <p class="log-placeholder">En attente de cr√©ation...</p>
                </div>
                <button onclick="clearLogs()" class="clear-btn">üóëÔ∏è Effacer les logs</button>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // SYST√àME DE LOGS
        // ========================================
        const logsContainer = document.getElementById('logs');

        function addLog(message, type = 'info') {
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;

            const timestamp = new Date().toLocaleTimeString('fr-CH');
            logEntry.innerHTML = `<span class="log-time">[${timestamp}]</span> ${message}`;

            // Retire le placeholder si pr√©sent
            const placeholder = logsContainer.querySelector('.log-placeholder');
            if (placeholder) placeholder.remove();

            logsContainer.appendChild(logEntry);
            logsContainer.scrollTop = logsContainer.scrollHeight;
        }

        function clearLogs() {
            logsContainer.innerHTML = '<p class="log-placeholder">Logs effac√©s...</p>';
        }

        // ========================================
        // TARIFS ‚Äî Chargement et affichage
        // ========================================
        let currentTarifs = {};
        let originalTarifs = {};

        const TARIF_LABELS = {
            base_price: 'Prix de base (CHF)',
            km_factor_proche: 'Facteur km proche',
            km_factor_loin: 'Facteur km loin',
            km_seuil: 'Seuil km',
            surface_factor_petit: 'Facteur surface petit',
            surface_factor_grand: 'Facteur surface grand',
            surface_seuil: 'Seuil surface (m¬≤)',
            plus_factor_petit: 'Facteur Plus petit',
            plus_factor_moyen: 'Facteur Plus moyen',
            plus_factor_grand: 'Facteur Plus grand',
            plus_seuil_petit: 'Seuil Plus petit (m¬≤)',
            plus_seuil_grand: 'Seuil Plus grand (m¬≤)',
            plus_price_max: 'Prix max Plus (CHF)',
            frais_emission_cecb: 'Frais √©mission CECB',
            frais_emission_cecb_plus: 'Frais √©mission CECB Plus',
            prix_conseil_incitatif: 'Prix conseil incitatif',
            conseil_restitution_cecb_plus: 'Conseil restitution (CHF/h)',
            demande_subvention_cecb_plus: 'Demande subvention (CHF/h)',
            forfait_normal: 'Forfait normal',
            forfait_express: 'Forfait express',
            forfait_urgent: 'Forfait urgent',
            frais_transfert_cecb: 'Frais transfert CECB'
        };

        const TARIF_SECTIONS = {
            'Prix de base': ['base_price'],
            'Distance': ['km_factor_proche', 'km_factor_loin', 'km_seuil'],
            'Surface': ['surface_factor_petit', 'surface_factor_grand', 'surface_seuil'],
            'CECB Plus': ['plus_factor_petit', 'plus_factor_moyen', 'plus_factor_grand', 'plus_seuil_petit', 'plus_seuil_grand', 'plus_price_max'],
            'Frais': ['frais_emission_cecb', 'frais_emission_cecb_plus', 'frais_transfert_cecb', 'prix_conseil_incitatif', 'conseil_restitution_cecb_plus', 'demande_subvention_cecb_plus'],
            'Forfaits': ['forfait_normal', 'forfait_express', 'forfait_urgent']
        };

        async function loadTarifs() {
            try {
                const response = await fetch('/api/tarifs');
                currentTarifs = await response.json();
                originalTarifs = JSON.parse(JSON.stringify(currentTarifs));
                renderTarifsPanel(currentTarifs);
                updateDelaiOptions();
                updateTransfertLabel();
            } catch (error) {
                console.error('Erreur chargement tarifs:', error);
                document.getElementById('tarifsFields').innerHTML = '<p class="tarif-info">Erreur de chargement</p>';
            }
        }

        function renderTarifsPanel(tarifs) {
            const container = document.getElementById('tarifsFields');
            let html = '';

            for (const [section, keys] of Object.entries(TARIF_SECTIONS)) {
                html += `<div class="tarif-separator">${section}</div>`;
                for (const key of keys) {
                    if (tarifs[key] !== undefined) {
                        const label = TARIF_LABELS[key] || key;
                        const step = Number.isInteger(tarifs[key]) ? '1' : '0.01';
                        html += `<div class="tarif-group">
                            <label for="tarif_${key}">${label}</label>
                            <input type="number" id="tarif_${key}" data-tarif-key="${key}" value="${tarifs[key]}" step="${step}">
                        </div>`;
                    }
                }
            }

            container.innerHTML = html;

            // √âcouter les changements pour mise √† jour dynamique
            container.querySelectorAll('input[data-tarif-key]').forEach(input => {
                input.addEventListener('change', function() {
                    const key = this.dataset.tarifKey;
                    currentTarifs[key] = parseFloat(this.value) || 0;
                    if (key === 'forfait_express' || key === 'forfait_urgent') {
                        updateDelaiOptions();
                    }
                    if (key === 'frais_transfert_cecb') {
                        updateTransfertLabel();
                    }
                });
            });
        }

        function updateDelaiOptions() {
            const expressOpt = document.getElementById('option_express');
            const urgentOpt = document.getElementById('option_urgent');
            if (expressOpt) expressOpt.textContent = `Express (+${currentTarifs.forfait_express || 155} CHF)`;
            if (urgentOpt) urgentOpt.textContent = `Urgent (+${currentTarifs.forfait_urgent || 310} CHF)`;
        }

        function updateTransfertLabel() {
            const label = document.getElementById('frais_transfert_label');
            if (label) label.textContent = currentTarifs.frais_transfert_cecb || 90;
        }

        function getTarifsOverride() {
            // Comparer les tarifs du panneau avec les originaux, ne renvoyer que les diff√©rences
            const overrides = {};
            for (const key of Object.keys(originalTarifs)) {
                const input = document.getElementById(`tarif_${key}`);
                if (input) {
                    const val = parseFloat(input.value);
                    if (!isNaN(val) && val !== originalTarifs[key]) {
                        overrides[key] = val;
                    }
                }
            }
            return Object.keys(overrides).length > 0 ? overrides : null;
        }

        // Log de chargement
        window.addEventListener('load', () => {
            addLog('‚úÖ Formulaire de cr√©ation de devis charg√©', 'success');
            addLog('üó∫Ô∏è  Autocompl√©tion Google Places activ√©e', 'info');

            // Charger les tarifs dans le panneau
            loadTarifs();

            // Pr√©-remplir le formulaire depuis les param√®tres URL
            prefillFormFromURL();
        });

        // ========================================
        // PR√â-REMPLISSAGE DEPUIS URL
        // ========================================
        function prefillFormFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            let prefillCount = 0;

            // Parcourir tous les param√®tres URL
            urlParams.forEach((value, key) => {
                const field = document.getElementById(key);
                if (field) {
                    // D√©coder la valeur (pour g√©rer les espaces, accents, etc.)
                    const decodedValue = decodeURIComponent(value);
                    field.value = decodedValue;
                    prefillCount++;

                    // D√©clencher l'√©v√©nement change pour les select
                    if (field.tagName === 'SELECT') {
                        field.dispatchEvent(new Event('change'));
                    }
                }
            });

            if (prefillCount > 0) {
                addLog(`üîó ${prefillCount} champ(s) pr√©-rempli(s) depuis l'URL`, 'success');
            }
        }

        // ========================================
        // GOOGLE PLACES AUTOCOMPLETE
        // ========================================
        let autocompleteFacturation, autocompleteBatiment;

        function initAutocomplete() {
            const optionsSwiss = {
                componentRestrictions: { country: 'ch' },
                fields: ['address_components', 'formatted_address', 'geometry'],
                types: ['address']
            };

            // Autocomplete pour adresse de facturation
            autocompleteFacturation = new google.maps.places.Autocomplete(
                document.getElementById('rue_facturation'),
                optionsSwiss
            );

            autocompleteFacturation.addListener('place_changed', () => {
                const place = autocompleteFacturation.getPlace();
                fillAddressFields(place, 'facturation');
            });

            // Autocomplete pour adresse du b√¢timent
            autocompleteBatiment = new google.maps.places.Autocomplete(
                document.getElementById('rue_batiment'),
                optionsSwiss
            );

            autocompleteBatiment.addListener('place_changed', () => {
                const place = autocompleteBatiment.getPlace();
                fillAddressFields(place, 'batiment');
            });
        }

        function fillAddressFields(place, type) {
            if (!place.address_components) {
                addLog(`‚ö†Ô∏è  Adresse ${type} incompl√®te`, 'error');
                return;
            }

            let streetNumber = '';
            let route = '';
            let postalCode = '';
            let locality = '';

            // Extraire les composants de l'adresse
            for (const component of place.address_components) {
                const componentType = component.types[0];

                switch (componentType) {
                    case 'street_number':
                        streetNumber = component.long_name;
                        break;
                    case 'route':
                        route = component.long_name;
                        break;
                    case 'postal_code':
                        postalCode = component.long_name;
                        break;
                    case 'locality':
                        locality = component.long_name;
                        break;
                }
            }

            // Remplir les champs
            const rueComplete = `${route} ${streetNumber}`.trim();
            document.getElementById(`rue_${type}`).value = rueComplete;
            document.getElementById(`npa_${type}`).value = postalCode;
            document.getElementById(`localite_${type}`).value = locality;

            addLog(`‚úÖ Adresse ${type} compl√©t√©e: ${rueComplete}, ${postalCode} ${locality}`, 'success');

            // Si "adresse identique" est coch√©e, copier vers b√¢timent
            if (type === 'facturation' && document.getElementById('adresse_identique').checked) {
                document.getElementById('rue_batiment').value = rueComplete;
                document.getElementById('npa_batiment').value = postalCode;
                document.getElementById('localite_batiment').value = locality;
                // R√©cup√©rer les donn√©es du b√¢timent
                fetchBuildingData(rueComplete, postalCode, locality);
            }

            // Si c'est l'adresse du b√¢timent, r√©cup√©rer les donn√©es du RegBL
            if (type === 'batiment') {
                fetchBuildingData(rueComplete, postalCode, locality);
            }
        }

        // Fonction pour r√©cup√©rer les donn√©es du b√¢timent depuis le RegBL
        async function fetchBuildingData(adresse, npa, localite) {
            try {
                addLog('üîç Recherche des donn√©es du b√¢timent dans le RegBL...', 'info');

                const response = await fetch('/api/building_data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        adresse: adresse,
                        npa: npa,
                        localite: localite
                    })
                });

                const data = await response.json();

                if (data.success && data.data) {
                    const gastw = data.data.gastw;
                    if (gastw) {
                        document.getElementById('nombre_etages').value = gastw;
                        addLog(`‚úÖ Nombre d'√©tages du RegBL: ${gastw}`, 'success');
                    }
                } else {
                    addLog('‚ö†Ô∏è  B√¢timent non trouv√© dans le RegBL - valeur par d√©faut utilis√©e', 'warning');
                }
            } catch (error) {
                console.error('Erreur lors de la r√©cup√©ration des donn√©es du b√¢timent:', error);
                addLog('‚ö†Ô∏è  Erreur lors de la recherche dans le RegBL', 'warning');
            }
        }

        // Initialiser l'autocomplete quand l'API Google est charg√©e
        if (typeof google !== 'undefined') {
            google.maps.event.addDomListener(window, 'load', initAutocomplete);
        } else {
            addLog('‚ö†Ô∏è  API Google Maps non disponible - autocompl√©tion d√©sactiv√©e', 'error');
        }

        // ========================================
        // GESTION DU FORMULAIRE
        // ========================================

        // Type de contact (Priv√©/Soci√©t√©)
        const typeContactSelect = document.getElementById('type_contact');
        const nomEntrepriseGroup = document.getElementById('group_nom_entreprise');
        const nomEntrepriseInput = document.getElementById('nom_entreprise');

        typeContactSelect.addEventListener('change', function() {
            if (this.value === 'Soci√©t√©') {
                nomEntrepriseGroup.classList.remove('hidden');
                nomEntrepriseInput.required = true;
                addLog('üìã Type de contact: Soci√©t√©', 'info');
            } else {
                nomEntrepriseGroup.classList.add('hidden');
                nomEntrepriseInput.required = false;
                addLog('üìã Type de contact: Priv√©', 'info');
            }
        });

        // Copie d'adresse
        const adresseIdentiqueCheckbox = document.getElementById('adresse_identique');
        const adresseBatimentFields = document.getElementById('adresse_batiment_fields');
        const rueFacturation = document.getElementById('rue_facturation');
        const npaFacturation = document.getElementById('npa_facturation');
        const localiteFacturation = document.getElementById('localite_facturation');
        const rueBatiment = document.getElementById('rue_batiment');
        const npaBatiment = document.getElementById('npa_batiment');
        const localiteBatiment = document.getElementById('localite_batiment');

        adresseIdentiqueCheckbox.addEventListener('change', function() {
            if (this.checked) {
                adresseBatimentFields.classList.add('hidden');
                rueBatiment.required = false;
                npaBatiment.required = false;
                localiteBatiment.required = false;

                // Copier les valeurs
                rueBatiment.value = rueFacturation.value;
                npaBatiment.value = npaFacturation.value;
                localiteBatiment.value = localiteFacturation.value;

                addLog('‚úÖ Adresse de facturation copi√©e vers b√¢timent', 'success');

                // R√©cup√©rer les donn√©es du b√¢timent si l'adresse est compl√®te
                if (rueBatiment.value && npaBatiment.value && localiteBatiment.value) {
                    fetchBuildingData(rueBatiment.value, npaBatiment.value, localiteBatiment.value);
                }
            } else {
                adresseBatimentFields.classList.remove('hidden');
                rueBatiment.required = true;
                npaBatiment.required = true;
                localiteBatiment.required = true;
                addLog('üìã Adresse du b√¢timent √† remplir s√©par√©ment', 'info');
            }
        });

        // Copie automatique pendant la saisie
        [rueFacturation, npaFacturation, localiteFacturation].forEach(input => {
            input.addEventListener('input', function() {
                if (adresseIdentiqueCheckbox.checked) {
                    rueBatiment.value = rueFacturation.value;
                    npaBatiment.value = npaFacturation.value;
                    localiteBatiment.value = localiteFacturation.value;
                }
            });
        });

        // Gestion du d√©lai selon le type de certificat
        const typeCertificatSelect = document.getElementById('type_certificat');
        const delaiGroup = document.getElementById('group_delai');

        typeCertificatSelect.addEventListener('change', function() {
            if (this.value === 'Conseil Incitatif') {
                delaiGroup.classList.add('hidden');
                addLog('üìã Type: Conseil Incitatif (gratuit)', 'info');
            } else {
                delaiGroup.classList.remove('hidden');
                addLog(`üìã Type: ${this.value}`, 'info');
            }
        });

        // CECB existant (mise √† jour)
        const cecbExistantCheckbox = document.getElementById('cecb_existant');
        const rabaisCecbGroup = document.getElementById('group_rabais_cecb');

        cecbExistantCheckbox.addEventListener('change', function() {
            if (this.checked) {
                rabaisCecbGroup.classList.remove('hidden');
                addLog('üìã CECB existant : rabais + transfert activ√©s', 'info');
            } else {
                rabaisCecbGroup.classList.add('hidden');
                document.getElementById('rabais_cecb').value = 0;
                addLog('üìã CECB existant d√©sactiv√©', 'info');
            }
        });

        // ========================================
        // SOUMISSION DU FORMULAIRE
        // ========================================
        const form = document.getElementById('devisForm');
        const submitBtn = document.getElementById('submitBtn');

        form.addEventListener('submit', async function(e) {
            e.preventDefault();

            // Pr√©parer les donn√©es
            const formData = new FormData(form);
            const data = {};
            formData.forEach((value, key) => {
                data[key] = value;
            });

            // Si adresse identique, copier les valeurs
            if (adresseIdentiqueCheckbox.checked) {
                data.rue_batiment = data.rue_facturation;
                data.npa_batiment = data.npa_facturation;
                data.localite_batiment = data.localite_facturation;
            }

            // CECB existant
            data.cecb_existant = cecbExistantCheckbox.checked;
            if (!data.cecb_existant) {
                delete data.rabais_cecb;
            }

            // Tarifs override (uniquement les valeurs modifi√©es)
            const tarifsOverride = getTarifsOverride();
            if (tarifsOverride) {
                data.tarifs_override = tarifsOverride;
            }

            // Le champ message va dans message_personnalise pour le script
            if (data.message) {
                data.message_personnalise = data.message;
            }

            // D√©sactiver le bouton
            submitBtn.disabled = true;
            submitBtn.textContent = '‚è≥ Cr√©ation en cours...';

            addLog('üöÄ Lancement de la cr√©ation du devis...', 'info');
            addLog(`üë§ Contact: ${data.prenom} ${data.nom_famille}`, 'info');
            addLog(`üè† B√¢timent: ${data.rue_batiment}, ${data.npa_batiment} ${data.localite_batiment}`, 'info');
            addLog(`üìã Type: ${data.type_certificat}`, 'info');

            try {
                const response = await fetch('/run_script', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        script_id: 'creer_devis',
                        args: {
                            form_data: JSON.stringify(data)
                        }
                    })
                });

                const responseData = await response.json();

                // R√©activer le bouton
                submitBtn.disabled = false;
                submitBtn.textContent = 'Cr√©er le devis';

                if (responseData.success) {
                    addLog(`‚úÖ <strong>Devis cr√©√© avec succ√®s !</strong> (${responseData.duration})`, 'success');
                    if (responseData.stdout) {
                        // Afficher le stdout ligne par ligne
                        const lines = responseData.stdout.split('\n');
                        lines.forEach(line => {
                            if (line.trim()) {
                                addLog(line, 'output');
                            }
                        });
                    }
                    addLog('üéâ Vous pouvez maintenant consulter le devis dans Bexio', 'success');
                } else {
                    addLog(`‚ùå <strong>Erreur lors de la cr√©ation du devis</strong>`, 'error');
                    if (responseData.stderr) {
                        addLog(`<pre>${responseData.stderr}</pre>`, 'error');
                    }
                    if (responseData.stdout) {
                        addLog('üìã Sortie du script:', 'info');
                        addLog(`<pre>${responseData.stdout}</pre>`, 'output');
                    }
                    if (responseData.error) {
                        addLog(`Erreur: ${responseData.error}`, 'error');
                    }
                }

            } catch (error) {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Cr√©er le devis';
                addLog(`‚ùå Erreur r√©seau: ${error.message}`, 'error');
                addLog('V√©rifiez que le serveur Flask est bien d√©marr√©.', 'error');
            }
        });

        // ==========================================
        // PHASE 3: PR√â-REMPLISSAGE DU FORMULAIRE
        // ==========================================

        {% if submission_data %}
        // Donn√©es de soumission √† pr√©-remplir
        const submissionData = {{ submission_data | tojson }};

        // Fonction pour pr√©-remplir le formulaire
        function prefillForm() {
            if (!submissionData || !submissionData.form_data) {
                return;
            }

            const formData = submissionData.form_data;

            console.log('üîÑ Pr√©-remplissage du formulaire avec:', formData);
            addLog('üîÑ Pr√©-remplissage du formulaire avec les donn√©es de la soumission...', 'info');

            // Fonction utilitaire pour d√©finir la valeur d'un champ
            function setFieldValue(fieldId, value) {
                const field = document.getElementById(fieldId);
                if (field && value !== null && value !== undefined) {
                    field.value = value;
                    // D√©clencher l'√©v√©nement change pour les select qui ont des listeners
                    field.dispatchEvent(new Event('change'));
                    return true;
                }
                return false;
            }

            // Fonction pour cocher une checkbox
            function setCheckbox(fieldId, value) {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.checked = Boolean(value);
                    field.dispatchEvent(new Event('change'));
                    return true;
                }
                return false;
            }

            // 1. Type de contact
            if (formData.type_contact) {
                setFieldValue('type_contact', formData.type_contact);
            }

            // 2. Nom entreprise (si soci√©t√©)
            if (formData.nom_entreprise) {
                setFieldValue('nom_entreprise', formData.nom_entreprise);
            }

            // 3. Appellation
            if (formData.appellation) {
                setFieldValue('appellation', formData.appellation);
            }

            // 4. Nom et pr√©nom
            setFieldValue('nom_famille', formData.nom_famille || formData.nom || '');
            setFieldValue('prenom', formData.prenom || '');

            // 5. Email et t√©l√©phone
            setFieldValue('email', formData.email || '');
            setFieldValue('telephone', formData.telephone || '');

            // 6. Adresse de facturation
            setFieldValue('rue_facturation', formData.rue_facturation || formData.adresse_facturation || '');
            setFieldValue('npa_facturation', formData.npa_facturation || formData.npa || '');
            setFieldValue('localite_facturation', formData.localite_facturation || formData.localite || '');
            setFieldValue('pays_facturation', formData.pays_facturation || 'Suisse');

            // 7. Adresse du b√¢timent
            if (formData.adresse_identique) {
                setCheckbox('adresse_identique', true);
            } else {
                setFieldValue('rue_batiment', formData.rue_batiment || formData.adresse_batiment || '');
                setFieldValue('npa_batiment', formData.npa_batiment || '');
                setFieldValue('localite_batiment', formData.localite_batiment || '');
            }

            // 8. Type de certificat
            if (formData.type_certificat) {
                setFieldValue('type_certificat', formData.type_certificat);
            }

            // 9. Caract√©ristiques du b√¢timent
            setFieldValue('nombre_etages', formData.nombre_etages || 2);
            setFieldValue('sous_sol', formData.sous_sol || 'Non chauff√©');
            setFieldValue('combles', formData.combles || 'Non chauff√©');

            // 10. D√©lai (si pas Conseil Incitatif)
            if (formData.delai) {
                setFieldValue('delai', formData.delai);
            }

            // 11. Contexte
            if (formData.contexte) {
                setFieldValue('contexte', formData.contexte);
            }

            // 12. Message
            setFieldValue('message', formData.message || formData.message_personnalise || '');

            // 13. CECB existant
            if (formData.cecb_existant) {
                setCheckbox('cecb_existant', true);
                if (formData.rabais_cecb) {
                    setFieldValue('rabais_cecb', formData.rabais_cecb);
                }
            }

            // Afficher un message de succ√®s
            addLog(`‚úÖ Formulaire pr√©-rempli avec les donn√©es de "${submissionData.client_name}"`, 'success');
            addLog(`üìã Type: ${submissionData.certificate_type} | Cr√©√© le: ${new Date(submissionData.created_at).toLocaleDateString('fr-CH')}`, 'info');

            // Scroll vers le haut du formulaire
            document.getElementById('devisForm').scrollIntoView({ behavior: 'smooth' });
        }

        // Pr√©-remplir automatiquement au chargement
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(prefillForm, 500); // Petit d√©lai pour s'assurer que tout est charg√©
        });
        {% endif %}
    </script>
</body>
</html>
