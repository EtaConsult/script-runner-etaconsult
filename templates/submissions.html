<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mes soumissions - √äta Consult S√†rl</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        /* Styles sp√©cifiques pour la page des soumissions */
        .submissions-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .page-header {
            margin-bottom: 30px;
        }

        .page-header h2 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .page-header p {
            color: #7f8c8d;
        }

        .submissions-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            flex: 1;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
            opacity: 0.9;
        }

        .stat-card .stat-value {
            font-size: 32px;
            font-weight: bold;
            margin: 0;
        }

        .stat-card.success { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
        .stat-card.pending { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .stat-card.error { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }

        .submissions-table {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .table-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 2px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-header h3 {
            margin: 0;
            color: #2c3e50;
        }

        .filter-buttons {
            display: flex;
            gap: 10px;
        }

        .filter-btn {
            padding: 6px 12px;
            border: 1px solid #dee2e6;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .filter-btn:hover {
            background: #e9ecef;
        }

        .filter-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #f8f9fa;
        }

        th {
            padding: 12px 20px;
            text-align: left;
            font-weight: 600;
            color: #495057;
            font-size: 13px;
            text-transform: uppercase;
        }

        td {
            padding: 15px 20px;
            border-top: 1px solid #e9ecef;
            color: #495057;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-badge.submitted {
            background: #fff3cd;
            color: #856404;
        }

        .status-badge.quote_created {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.error {
            background: #f8d7da;
            color: #721c24;
        }

        .cert-type {
            font-weight: 600;
            color: #007bff;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .action-btn.view {
            background: #007bff;
            color: white;
        }

        .action-btn.view:hover {
            background: #0056b3;
        }

        .action-btn.delete {
            background: #dc3545;
            color: white;
        }

        .action-btn.delete:hover {
            background: #c82333;
        }

        .action-btn.recall {
            background: #17a2b8;
            color: white;
        }

        .action-btn.recall:hover {
            background: #138496;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .empty-state img {
            width: 200px;
            opacity: 0.5;
            margin-bottom: 20px;
        }

        .empty-state h3 {
            margin: 20px 0 10px;
            color: #495057;
        }

        .empty-state p {
            margin-bottom: 20px;
        }

        .btn-primary {
            display: inline-block;
            padding: 10px 20px;
            background: #007bff;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            transition: background 0.3s;
        }

        .btn-primary:hover {
            background: #0056b3;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .loading::after {
            content: "...";
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: "."; }
            40% { content: ".."; }
            60%, 100% { content: "..."; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div class="header-left">
                    <h1>üìã Mes soumissions</h1>
                    <p class="subtitle">Historique de vos devis CECB</p>
                </div>
                <div class="header-right">
                    <nav class="admin-nav">
                        <a href="/" class="admin-link" title="Retour au tableau de bord">üè† Tableau de bord</a>
                        {% if current_user.is_admin() %}
                        <a href="/admin/tarifs" class="admin-link" title="G√©rer les tarifs">‚öôÔ∏è Tarifs</a>
                        <a href="/admin/textes" class="admin-link" title="G√©rer les textes des devis">üìù Textes</a>
                        <a href="/tests" class="admin-link" title="Liens de test avec formulaires pr√©-remplis">üß™ Tests</a>
                        <a href="/admin/users" class="admin-link" title="G√©rer les utilisateurs">üë• Utilisateurs</a>
                        {% endif %}
                        <a href="/devis/nouveau" class="admin-link devis-link" title="Cr√©er un nouveau devis">‚ûï Nouveau Devis</a>
                        <span class="user-info" title="Utilisateur connect√©">üë§ {{ current_user.email }}</span>
                        <a href="/logout" class="admin-link logout-link" title="Se d√©connecter">üö™ D√©connexion</a>
                    </nav>
                </div>
            </div>
        </header>

        <div class="submissions-container">
            <!-- Statistiques -->
            <div class="submissions-stats">
                <div class="stat-card">
                    <h3>Total</h3>
                    <p class="stat-value" id="stat-total">-</p>
                </div>
                <div class="stat-card success">
                    <h3>Devis cr√©√©s</h3>
                    <p class="stat-value" id="stat-success">-</p>
                </div>
                <div class="stat-card pending">
                    <h3>En attente</h3>
                    <p class="stat-value" id="stat-pending">-</p>
                </div>
                <div class="stat-card error">
                    <h3>Erreurs</h3>
                    <p class="stat-value" id="stat-error">-</p>
                </div>
            </div>

            <!-- Table des soumissions -->
            <div class="submissions-table">
                <div class="table-header">
                    <h3>Historique des soumissions</h3>
                    <div class="filter-buttons">
                        <button class="filter-btn active" onclick="filterSubmissions('all')">Tous</button>
                        <button class="filter-btn" onclick="filterSubmissions('quote_created')">Cr√©√©s</button>
                        <button class="filter-btn" onclick="filterSubmissions('submitted')">En attente</button>
                        <button class="filter-btn" onclick="filterSubmissions('error')">Erreurs</button>
                    </div>
                </div>

                <div id="table-container">
                    <div class="loading">Chargement des soumissions</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let allSubmissions = [];
        let currentFilter = 'all';

        // Charger les soumissions au chargement de la page
        document.addEventListener('DOMContentLoaded', function() {
            loadSubmissions();
        });

        async function loadSubmissions() {
            try {
                const response = await fetch('/api/submissions');
                const data = await response.json();

                if (data.success) {
                    allSubmissions = data.submissions;
                    updateStats();
                    renderSubmissions();
                } else {
                    showError(data.error);
                }
            } catch (error) {
                showError('Erreur lors du chargement des soumissions: ' + error.message);
            }
        }

        function updateStats() {
            const total = allSubmissions.length;
            const success = allSubmissions.filter(s => s.status === 'quote_created').length;
            const pending = allSubmissions.filter(s => s.status === 'submitted').length;
            const error = allSubmissions.filter(s => s.status === 'error').length;

            document.getElementById('stat-total').textContent = total;
            document.getElementById('stat-success').textContent = success;
            document.getElementById('stat-pending').textContent = pending;
            document.getElementById('stat-error').textContent = error;
        }

        function filterSubmissions(status) {
            currentFilter = status;

            // Mettre √† jour les boutons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            renderSubmissions();
        }

        function renderSubmissions() {
            const container = document.getElementById('table-container');

            // Filtrer les soumissions
            let filtered = allSubmissions;
            if (currentFilter !== 'all') {
                filtered = allSubmissions.filter(s => s.status === currentFilter);
            }

            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>Aucune soumission</h3>
                        <p>Vous n'avez pas encore cr√©√© de devis CECB.</p>
                        <a href="/devis/nouveau" class="btn-primary">Cr√©er un nouveau devis</a>
                    </div>
                `;
                return;
            }

            const tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Client</th>
                            <th>Adresse</th>
                            <th>Type</th>
                            <th>Statut</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filtered.map(submission => `
                            <tr data-id="${submission.id}">
                                <td>${formatDate(submission.created_at)}</td>
                                <td><strong>${submission.client_name || 'N/A'}</strong></td>
                                <td>${submission.building_address || 'N/A'}</td>
                                <td><span class="cert-type">${submission.certificate_type || 'N/A'}</span></td>
                                <td><span class="status-badge ${submission.status}">${getStatusLabel(submission.status)}</span></td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="action-btn recall" onclick="recallSubmission(${submission.id})" title="Rappeler et pr√©-remplir">üîÑ</button>
                                        <button class="action-btn view" onclick="viewSubmission(${submission.id})" title="Voir les d√©tails">üëÅÔ∏è</button>
                                        <button class="action-btn delete" onclick="deleteSubmission(${submission.id})" title="Supprimer">üóëÔ∏è</button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            container.innerHTML = tableHTML;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('fr-CH', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function getStatusLabel(status) {
            const labels = {
                'submitted': 'En attente',
                'quote_created': 'Cr√©√©',
                'error': 'Erreur'
            };
            return labels[status] || status;
        }

        async function viewSubmission(id) {
            try {
                const response = await fetch(`/api/submissions/${id}`);
                const data = await response.json();

                if (data.success) {
                    const sub = data.submission;
                    const details = `
D√©tails de la soumission #${sub.id}
================================
Client: ${sub.client_name}
Email: ${sub.form_data.email || 'N/A'}
T√©l√©phone: ${sub.form_data.telephone || 'N/A'}
Type: ${sub.certificate_type}
Adresse: ${sub.building_address}
Statut: ${getStatusLabel(sub.status)}
${sub.bexio_document_nr ? `Devis Bexio: ${sub.bexio_document_nr} (ID: ${sub.bexio_quote_id})` : ''}
${sub.error_message ? `Erreur: ${sub.error_message}` : ''}

Cr√©√©e le: ${formatDate(sub.created_at)}
Derni√®re modification: ${formatDate(sub.updated_at)}
                    `;
                    alert(details);
                } else {
                    alert('Erreur: ' + data.error);
                }
            } catch (error) {
                alert('Erreur lors de la r√©cup√©ration: ' + error.message);
            }
        }

        function recallSubmission(id) {
            // Rediriger vers le formulaire de cr√©ation avec pr√©-remplissage
            window.location.href = `/devis/nouveau/${id}`;
        }

        async function deleteSubmission(id) {
            if (!confirm('√ätes-vous s√ªr de vouloir supprimer cette soumission ?')) {
                return;
            }

            try {
                const response = await fetch(`/api/submissions/${id}`, {
                    method: 'DELETE'
                });
                const data = await response.json();

                if (data.success) {
                    alert('Soumission supprim√©e avec succ√®s');
                    loadSubmissions(); // Recharger la liste
                } else {
                    alert('Erreur: ' + data.error);
                }
            } catch (error) {
                alert('Erreur lors de la suppression: ' + error.message);
            }
        }

        function showError(message) {
            const container = document.getElementById('table-container');
            container.innerHTML = `
                <div class="empty-state">
                    <h3>Erreur</h3>
                    <p>${message}</p>
                    <button onclick="loadSubmissions()" class="btn-primary">R√©essayer</button>
                </div>
            `;
        }
    </script>
</body>
</html>
